
> # data <- data.matrix(data[,-1])
> data <- dengueDF.sj %>% arrange(week_start_date) %>% select(-year,-week_start_date)

> train_data <- data[(1:nrow(data)*0.7),]

> mean <- apply(train_data, 2, mean)

> std <- apply(train_data, 2, sd)

> data <- scale(data, center = mean, scale = std)

> generator <- function(data, lookback, delay, min_index, max_index,
+                       shuffle = FALSE, batch_size = 128, step = 1) {
+     if ( .... [TRUNCATED] 

> lookback <- 4

> step <- 1

> delay <- 1

> batch_size <- 4

> train_gen <- generator(
+     data,
+     lookback = lookback,
+     delay = delay,
+     min_index = 1,
+     max_index = 550,
+     shuffle = FALS .... [TRUNCATED] 

> head(data); train_gen()
     weekofyear    ndvi_ne   ndvi_nw    ndvi_se    ndvi_sw precipitation_amt_mm
[1,] -0.5978355  0.4049784 0.1054374  0.3160629  0.1827910         -0.532770957
[2,] -0.5304971  0.9143911 0.5745327 -0.3315854 -0.2104282         -0.280002829
[3,] -0.4631587 -0.5680752 0.9501958 -0.4240387  0.0624355          0.004847409
[4,] -0.3958203  0.4699560 1.8298258  0.8372800  1.2181031         -0.461315352
[5,] -0.3284818  1.1976375 2.0388544  1.2611353  1.4216209         -0.651863633
[6,] -0.2611434  1.4868073 0.9731723  1.3169666  0.2561045         -0.601796100
     reanalysis_precip_amt_kg_per_m2 reanalysis_relative_humidity_percent
[1,]                    9.268423e-05                           -1.6642160
[2,]                   -3.929512e-01                           -0.4925697
[3,]                   -1.648404e-01                            0.8785323
[4,]                   -5.058884e-01                            0.3763385
[5,]                   -5.534115e-01                            0.4122991
[6,]                   -1.539380e-01                            0.2458768
     reanalysis_sat_precip_amt_mm reanalysis_specific_humidity_g_per_kg reanalysis_tdtr_k
[1,]                 -0.534049081                           -1.62557530        0.40229421
[2,]                 -0.281743756                           -0.74604526       -0.13015401
[3,]                  0.002584936                            0.20831874       -0.27805629
[4,]                 -0.462724306                            0.09468198       -0.01183218
[5,]                 -0.652923705                            0.44205939        1.20096654
[6,]                 -0.602947843                            0.44390715       -0.69218269
     station_avg_temp_c station_diur_temp_rng_c station_max_temp_c station_min_temp_c
[1,]         -1.1935637              0.05273461        -1.42876272         -1.7655284
[2,]         -0.2618076             -0.58649243        -0.02236631         -0.2813879
[3,]         -0.2618076             -0.44828118         0.28337204          0.1233778
[4,]          0.2930584             -0.10275304         0.95599640          0.4606824
[5,]          1.3713828              3.04155296         1.99550679          0.8654480
[6,]          0.7641710              0.10456383         1.62862077          0.8654480
     station_precip_mm reanalysis_air_temp_c reanalysis_avg_temp_c reanalysis_dew_point_temp_c
[1,]        -0.3232962           -1.24298539           -1.21316293                  -1.7080104
[2,]        -0.5794526           -0.70048889           -0.60676015                  -0.7249596
[3,]         0.5559435           -0.21624705           -0.22930536                   0.2233737
[4,]        -0.7386850           -0.04148308            0.07389603                   0.1438891
[5,]        -0.6763767            0.40999052            0.45135082                   0.4709637
[6,]         0.4763273            0.50465433            0.53797979                   0.4901496
     reanalysis_max_air_temp_c reanalysis_min_air_temp_c total_cases
[1,]                -1.2215033               -1.05085194  -0.6161365
[2,]                -0.3052199               -0.65276971  -0.5988604
[3,]                -0.6384139                0.06377831  -0.6161365
[4,]                 0.1112725               -0.17507103  -0.6334126
[5,]                 0.5277650                0.22301120  -0.5815844
[6,]                 0.9442574                0.70070988  -0.6506886
[[1]]
, , 1

           [,1]       [,2]       [,3]       [,4]
[1,] -0.5978355 -0.5304971 -0.4631587 -0.3958203
[2,] -0.5304971 -0.4631587 -0.3958203 -0.3284818
[3,] -0.4631587 -0.3958203 -0.3284818 -0.2611434
[4,] -0.3958203 -0.3284818 -0.2611434 -0.1938050

, , 2

           [,1]       [,2]       [,3]      [,4]
[1,]  0.4049784  0.9143911 -0.5680752 0.4699560
[2,]  0.9143911 -0.5680752  0.4699560 1.1976375
[3,] -0.5680752  0.4699560  1.1976375 1.4868073
[4,]  0.4699560  1.1976375  1.4868073 0.3005111

, , 3

          [,1]      [,2]      [,3]        [,4]
[1,] 0.1054374 0.5745327 0.9501958  1.82982578
[2,] 0.5745327 0.9501958 1.8298258  2.03885442
[3,] 0.9501958 1.8298258 2.0388544  0.97317227
[4,] 1.8298258 2.0388544 0.9731723 -0.02784914

, , 4

           [,1]       [,2]       [,3]      [,4]
[1,]  0.3160629 -0.3315854 -0.4240387 0.8372800
[2,] -0.3315854 -0.4240387  0.8372800 1.2611353
[3,] -0.4240387  0.8372800  1.2611353 1.3169666
[4,]  0.8372800  1.2611353  1.3169666 0.4341703

, , 5

           [,1]       [,2]      [,3]      [,4]
[1,]  0.1827910 -0.2104282 0.0624355 1.2181031
[2,] -0.2104282  0.0624355 1.2181031 1.4216209
[3,]  0.0624355  1.2181031 1.4216209 0.2561045
[4,]  1.2181031  1.4216209 0.2561045 0.7629933

, , 6

             [,1]         [,2]         [,3]       [,4]
[1,] -0.532770957 -0.280002829  0.004847409 -0.4613154
[2,] -0.280002829  0.004847409 -0.461315352 -0.6518636
[3,]  0.004847409 -0.461315352 -0.651863633 -0.6017961
[4,] -0.461315352 -0.651863633 -0.601796100 -0.7500543

, , 7

              [,1]       [,2]       [,3]       [,4]
[1,]  9.268423e-05 -0.3929512 -0.1648404 -0.5058884
[2,] -3.929512e-01 -0.1648404 -0.5058884 -0.5534115
[3,] -1.648404e-01 -0.5058884 -0.5534115 -0.1539380
[4,] -5.058884e-01 -0.5534115 -0.1539380  0.1845941

, , 8

           [,1]       [,2]      [,3]      [,4]
[1,] -1.6642160 -0.4925697 0.8785323 0.3763385
[2,] -0.4925697  0.8785323 0.3763385 0.4122991
[3,]  0.8785323  0.3763385 0.4122991 0.2458768
[4,]  0.3763385  0.4122991 0.2458768 0.8630609

, , 9

             [,1]         [,2]         [,3]       [,4]
[1,] -0.534049081 -0.281743756  0.002584936 -0.4627243
[2,] -0.281743756  0.002584936 -0.462724306 -0.6529237
[3,]  0.002584936 -0.462724306 -0.652923705 -0.6029478
[4,] -0.462724306 -0.652923705 -0.602947843 -0.7509346

, , 10

            [,1]        [,2]       [,3]       [,4]
[1,] -1.62557530 -0.74604526 0.20831874 0.09468198
[2,] -0.74604526  0.20831874 0.09468198 0.44205939
[3,]  0.20831874  0.09468198 0.44205939 0.44390715
[4,]  0.09468198  0.44205939 0.44390715 0.45776529

, , 11

            [,1]        [,2]        [,3]        [,4]
[1,]  0.40229421 -0.13015401 -0.27805629 -0.01183218
[2,] -0.13015401 -0.27805629 -0.01183218  1.20096654
[3,] -0.27805629 -0.01183218  1.20096654 -0.69218269
[4,] -0.01183218  1.20096654 -0.69218269 -0.81050451

, , 12

           [,1]       [,2]       [,3]      [,4]
[1,] -1.1935637 -0.2618076 -0.2618076 0.2930584
[2,] -0.2618076 -0.2618076  0.2930584 1.3713828
[3,] -0.2618076  0.2930584  1.3713828 0.7641710
[4,]  0.2930584  1.3713828  0.7641710 0.2511817

, , 13

            [,1]       [,2]       [,3]       [,4]
[1,]  0.05273461 -0.5864924 -0.4482812 -0.1027530
[2,] -0.58649243 -0.4482812 -0.1027530  3.0415530
[3,] -0.44828118 -0.1027530  3.0415530  0.1045638
[4,] -0.10275304  3.0415530  0.1045638 -0.1027530

, , 14

            [,1]        [,2]      [,3]      [,4]
[1,] -1.42876272 -0.02236631 0.2833720 0.9559964
[2,] -0.02236631  0.28337204 0.9559964 1.9955068
[3,]  0.28337204  0.95599640 1.9955068 1.6286208
[4,]  0.95599640  1.99550679 1.6286208 0.2833720

, , 15

           [,1]       [,2]      [,3]      [,4]
[1,] -1.7655284 -0.2813879 0.1233778 0.4606824
[2,] -0.2813879  0.1233778 0.4606824 0.8654480
[3,]  0.1233778  0.4606824 0.8654480 0.8654480
[4,]  0.4606824  0.8654480 0.8654480 0.4606824

, , 16

           [,1]       [,2]       [,3]       [,4]
[1,] -0.3232962 -0.5794526  0.5559435 -0.7386850
[2,] -0.5794526  0.5559435 -0.7386850 -0.6763767
[3,]  0.5559435 -0.7386850 -0.6763767  0.4763273
[4,] -0.7386850 -0.6763767  0.4763273  0.1509394

, , 17

            [,1]        [,2]        [,3]        [,4]
[1,] -1.24298539 -0.70048889 -0.21624705 -0.04148308
[2,] -0.70048889 -0.21624705 -0.04148308  0.40999052
[3,] -0.21624705 -0.04148308  0.40999052  0.50465433
[4,] -0.04148308  0.40999052  0.50465433  0.14541728

, , 18

            [,1]        [,2]        [,3]       [,4]
[1,] -1.21316293 -0.60676015 -0.22930536 0.07389603
[2,] -0.60676015 -0.22930536  0.07389603 0.45135082
[3,] -0.22930536  0.07389603  0.45135082 0.53797979
[4,]  0.07389603  0.45135082  0.53797979 0.06770825

, , 19

           [,1]       [,2]      [,3]      [,4]
[1,] -1.7080104 -0.7249596 0.2233737 0.1438891
[2,] -0.7249596  0.2233737 0.1438891 0.4709637
[3,]  0.2233737  0.1438891 0.4709637 0.4901496
[4,]  0.1438891  0.4709637 0.4901496 0.4992858

, , 20

           [,1]       [,2]       [,3]       [,4]
[1,] -1.2215033 -0.3052199 -0.6384139 0.11127252
[2,] -0.3052199 -0.6384139  0.1112725 0.52776496
[3,] -0.6384139  0.1112725  0.5277650 0.94425740
[4,]  0.1112725  0.5277650  0.9442574 0.02797404

, , 21

            [,1]        [,2]        [,3]       [,4]
[1,] -1.05085194 -0.65276971  0.06377831 -0.1750710
[2,] -0.65276971  0.06377831 -0.17507103  0.2230112
[3,]  0.06377831 -0.17507103  0.22301120  0.7007099
[4,] -0.17507103  0.22301120  0.70070988  0.3822441


[[2]]
[1] -0.6506886 -0.6161365 -0.5988604 -0.5124801


> val_gen = generator(
+     data,
+     lookback = lookback,
+     delay = delay,
+     min_index = 551,
+     max_index = 700,
+     step = step,
+  .... [TRUNCATED] 

> test_gen <- generator(
+     data,
+     lookback = lookback,
+     delay = delay,
+     min_index = 701,
+     max_index = NULL,
+     step = step, .... [TRUNCATED] 

> # How many steps to draw from val_gen in order to see the entire validation set
> val_steps <- (701 - 551 - lookback) / batch_size

> val_steps
[1] 36.5

> # How many steps to draw from test_gen in order to see the entire test set
> test_steps <- (nrow(data) - 701 - lookback) / batch_size

> test_steps
[1] 57.75

> model <- keras_model_sequential() %>%
+     layer_gru(units = 32,
+               input_shape = list(NULL, (dim(data)[[-1]]-1)),
+               dro .... [TRUNCATED] 

> model %>% compile(
+     optimizer = optimizer_rmsprop(),
+     loss = "mae"
+ )

> # tensorboard("logs/run_c", reload_interval = 10)
> history <- model %>% fit_generator(
+     train_gen,
+     steps_per_epoch = 200,
+     epochs = .... [TRUNCATED] 

> # plot(history)
